version: '3.8'

services:
    # Banco de dados PostgreSQL
    postgres:
        image: postgres:15-alpine
        container_name: financeiro_postgres
        environment:
            POSTGRES_DB: financeiro_db
            POSTGRES_USER: financeiro_user
            POSTGRES_PASSWORD: financeiro_password
            PGDATA: /var/lib/postgresql/data/pgdata
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./database/init:/docker-entrypoint-initdb.d
        ports:
            - "5432:5432"
        networks:
            - financeiro_network
        restart: unless-stopped

    # Backend NestJS
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: financeiro_backend
        environment:
            - NODE_ENV=development
            - DATABASE_URL=postgres://financeiro_user:financeiro_password@postgres:5432/financeiro_db
            - JWT_SECRET=jwt_secret_key
            - PORT=3001
        volumes:
            - ./backend:/app
            - /app/node_modules
        ports:
            - "3001:3001"
        depends_on:
            - postgres
        networks:
            - financeiro_network
        restart: unless-stopped
        command: npm run start:dev

    # Frontend NextJS
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
        container_name: financeiro_frontend
        environment:
            - NEXT_PUBLIC_API_URL=http://192.168.0.19:3001/api/v1
        volumes:
            - ./frontend:/app
            - /app/node_modules
            - /app/.next
        ports:
            - "3000:3000"
        depends_on:
            - backend
        networks:
            - financeiro_network
        restart: unless-stopped
        command: npm run dev
    
    # PgAdmin para gerenciamento do banco
    pgadmin:
        image: dpage/pgadmin4:latest
        container_name: financeiro_pgadmin
        environment:
            PGADMIN_DEFAULT_EMAIL: admin@financeiro.com
            PGADMIN_DEFAULT_PASSWORD: admin123
            PGADMIN_CONFIG_SERVER_MODE: 'False'
        volumes:
            - pgadmin_data:/var/lib/pgadmin
        ports:
            - "5050:80"
        depends_on:
            - postgres
        networks:
            - financeiro_network
        restart: unless-stopped
volumes:
    postgres_data:
    pgadmin_data:

networks:
    financeiro_network:
        driver: bridge